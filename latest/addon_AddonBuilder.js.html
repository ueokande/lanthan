<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8">
    <title>JSDoc: Source: addon/AddonBuilder.js</title>

    <script src="scripts/prettify/prettify.js"> </script>
    <script src="scripts/prettify/lang-css.js"> </script>
    <!--[if lt IE 9]>
      <script src="//html5shiv.googlecode.com/svn/trunk/html5.js"></script>
    <![endif]-->
    <link type="text/css" rel="stylesheet" href="styles/prettify-tomorrow.css">
    <link type="text/css" rel="stylesheet" href="styles/jsdoc-default.css">
</head>

<body>

<div id="main">

    <h1 class="page-title">Source: addon/AddonBuilder.js</h1>

    



    
    <section>
        <article>
            <pre class="prettyprint source linenums"><code>'use strict';

const fs = require('fs');
const path = require('path');
const Manifest = require('./Manifest');
const JSZip = require('jszip');

/**
 * AddonBuilder builds an WebExtensions archive.
 *
 * @example
 * let data = await new AddonBuilder('path/to/addon/directory').build()
 * fs.writeFileSync('my-addon.zip', data);
 */
class AddonBuilder {

  /**
   * @param {string} baseDir Path to base directory of the addon manifest.
   */
  constructor(baseDir) {
    this.baseDir = baseDir;
    this.addionalBackground = [];
    this.additionalPermission = [];
    this.overrides = {};
    this.zip = new JSZip();
  }

  /**
   * Adds file to the addon archive.  The name is the relative path of the
   * &lt;code>manifest.json&lt;/code>.  If the content is omitted, it loads file
   * from the relative path &lt;cod>name&lt;/code> of the manifest.
   *
   * @example
   * let data = await new AddonBuilder('path/to/addon/directory');
   *
   * // adds file from file
   * builder.addFile('resources/debug.js', '// hello world');
   *
   * // adds file from the content
   * builder.addFile('resources/debug.js');
   *
   * @param {string} name The relative path to the resource file.
   * @param {Object=} content The content of the file.
   * @returns {AddonBuilder} This builder object.
   */
  addFile(name, content) {
    if (content) {
      this.zip.file(name, content);
      return this;
    }

    let realpath = path.resolve(name);
    let baseDir = path.resolve(this.baseDir);
    if (!realpath.startsWith(baseDir)) {
      throw new Error(`file ${name} is out of directory of the addon`);
    }

    let basename = path.relative(baseDir, realpath);
    let data = fs.readFileSync(realpath);
    this.zip.file(basename, data);

    return this;
  }

  /**
   * Adds background script to the addon archive and define background scripts
   * in the manifest.  Adds file to the addon archive.  The name is the
   * relative path of the &lt;code>manifest.json&lt;/code>.  If the content is
   * omitted, it loads file from the relative path &lt;cod>name&lt;/code> of the
   * manifest.
   *
   * @example
   * let data = await new AddonBuilder('path/to/addon/directory');
   *
   * // adds file from file
   * builder.addBackgroundScript('built/debug.js', '// hello world');
   *
   * // adds file from the content
   * builder.addBackgroundScript('built/debug.js');
   *
   * @param{string} name String parameters
   * @param{Buffer} content String parameters
   * @returns {AddonBuilder} This builder object.
   */
  addBackgroundScript(name, content) {
    this.addionalBackground.push(name);
    this.addFile(name, content);

    return this;
  }

  /**
   * Adds permission to the manifest.
   *
   * @param {string} permission Additional permission
   * @returns {AddonBuilder} This builder object.
   */
  addPermission(permission) {
    this.additionalPermission.push(permission);

    return this;
  }

  /**
   * Overrides manifest values of the field.
   *
   * @param {string} name Field name to override manifest.
   * @param {Object} value Overrode value of the manifest.
   * @returns {AddonBuilder} This builder object.
   */
  overrideProperty(name, value) {
    this.overrides[name] = value;

    return this;
  }

  /**
   * Builds and returns package date.
   *
   * @async
   * @returns {Promise&lt;Buffer>} Generated zip file
   */
  build() {
    let manifestPath = path.join(this.baseDir, 'manifest.json');
    let manifestData = JSON.parse(fs.readFileSync(manifestPath));
    let manifest = new Manifest(manifestData);

    manifest.dependencies().forEach((r) => {
      let data = fs.readFileSync(path.join(this.baseDir, r));
      this.zip.file(r, data);
    });

    manifestData.background = manifestData.background || {};
    manifestData.background.scripts = this.addionalBackground.concat(manifestData.background.scripts || []);
    manifestData.permissions = this.additionalPermission.concat(manifestData.permissions || []);
    for (let key of Object.keys(this.overrides)) {
      manifestData[key] = this.overrides[key];
    }
    this.zip.file('manifest.json', JSON.stringify(manifestData, 2));

    return this.zip.generateAsync({
      compression: 'DEFLATE',
      type: 'nodebuffer'
    });
  }
}

module.exports = AddonBuilder;
</code></pre>
        </article>
    </section>




</div>

<nav>
    <h2><a href="index.html">Home</a></h2><h3>Classes</h3><ul><li><a href="AddonBuilder.html">AddonBuilder</a></li><li><a href="BadRequestError.html">BadRequestError</a></li><li><a href="Browser.html">Browser</a></li><li><a href="Element.html">Element</a></li><li><a href="GeckoDriver.html">GeckoDriver</a></li><li><a href="GeckoSession.html">GeckoSession</a></li><li><a href="HttpError.html">HttpError</a></li><li><a href="Logger.html">Logger</a></li><li><a href="Manifest.html">Manifest</a></li><li><a href="MessageClient.html">MessageClient</a></li><li><a href="MessageListener.html">MessageListener</a></li><li><a href="NotAcceptableError.html">NotAcceptableError</a></li><li><a href="NotFoundError.html">NotFoundError</a></li><li><a href="Server.html">Server</a></li><li><a href="Session.html">Session</a></li><li><a href="WebDriver.html">WebDriver</a></li></ul><h3>Global</h3><ul><li><a href="global.html#create">create</a></li><li><a href="global.html#createManifest">createManifest</a></li><li><a href="global.html#Keys">Keys</a></li><li><a href="global.html#maxArgs">maxArgs</a></li><li><a href="global.html#methods">methods</a></li><li><a href="global.html#minArgs">minArgs</a></li><li><a href="global.html#mkdirAllSync">mkdirAllSync</a></li><li><a href="global.html#removeManifest">removeManifest</a></li></ul>
</nav>

<br class="clear">

<footer>
    Documentation generated by <a href="https://github.com/jsdoc3/jsdoc">JSDoc 3.5.5</a> on Wed Apr 24 2019 21:39:52 GMT+0900 (Japan Standard Time)
</footer>

<script> prettyPrint(); </script>
<script src="scripts/linenumber.js"> </script>
</body>
</html>
